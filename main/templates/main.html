{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Fantasy Football</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
{% include 'edit_modal.html' %}

<div class="relative w-full min-h-screen flex -mt-16 bg-[#4b4197]">

  <div class="absolute inset-0">
    <img src="{% static 'images/bg_main.png' %}" alt="Background" class="w-full h-full object-cover">
    <div class="absolute inset-0 bg-black bg-opacity-25"></div>
  </div>

  <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 text-gray-900">

    <!-- Header -->
    <div class="mb-8 text-center">
      <h1 class="text-5xl font-byte text-white mb-2 drop-shadow-lg">Newest Item</h1>
      <p class="text-gray-200 font-custom1">Time to win more matches!</p>
    </div>

    <!-- Filter -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 bg-[#f1e6ff]/75 backdrop-blur-sm rounded-lg border border-gray-200 p-4 shadow-md">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <button 
           id="filter-all"
           class="bg-[#4b4197] text-white px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d]">
          All Item
        </button>
        <button 
           id="filter-my"
           class="bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d] hover:text-white">
          My Item
        </button>
        <button id="refresh-button" title="Refresh data"
            class="bg-white text-gray-700 border border-gray-300 p-2 rounded-md transition-all duration-300 hover:bg-[#3b347d] hover:text-white focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-[#4b4197]">
          <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M20 4l-4 4M4 20l4-4M12 4v16"></path>
          </svg>
        </button>
      </div>
      {% if user.is_authenticated %}
        <div class="text-sm font-custom1 text-gray-700">
          Last login: {{ last_login }}
        </div>
      {% endif %}
    </div>

    <!-- Container animation -->
    <div id="item-container" class="transition-all duration-500 opacity-100 translate-y-0 min-h-[400px]">
      
      <!-- Loading -->
      <div id="loading" class="bg-white/80 backdrop-blur-sm rounded-lg border border-gray-200 p-12 text-center hidden">
        <svg class="animate-spin h-8 w-8 text-[#4b4197] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
        </svg>
        <p class="text-gray-600 mt-3 font-custom1">Loading items...</p>
      </div>

      <!-- Error -->
      <div id="error" class="hidden"></div>

      <!-- Grid Container -->
      <div id="grid" class="hidden transition-opacity duration-300"></div>
      <div id="empty" class="bg-white/80 backdrop-blur-sm rounded-lg border border-gray-200 p-12 text-center shadow-md hidden transition-opacity duration-300">

      
        <div class="w-32 h-32 mx-auto mb-4">
          <img src="{% static 'images/no_item.png' %}" alt="No items available" class="w-full h-full object-contain">
        </div>
        <h3 class="text-lg font-medium text-gray-900 mb-2">No item found</h3>
        <p class="text-gray-500 mb-6">Be the first one to get Rich!</p>
        <a href="{% url 'main:create_item' %}" class="inline-flex items-center px-4 py-2 bg-[#4b4197] text-white rounded-md hover:bg-[#3b347d] transition-colors font-custom1">
          Create Item
        </a>
      </div>
      
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm">
      <div class="bg-white rounded-lg shadow-lg p-6 w-80 text-center">
        <h3 class="text-lg font-semibold text-gray-900 mb-4 font-custom1">Are you sure?</h3>
        <p class="text-gray-600 mb-6 font-custom1">This item will be permanently deleted.</p>
        <div class="flex justify-center space-x-4">
          <button id="cancelDelete" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md font-custom1 hover:bg-gray-400 transition">Cancel</button>
          <button id="confirmDelete" class="px-4 py-2 bg-red-600 text-white rounded-md font-custom1 hover:bg-red-700 transition">Delete</button>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- AJAX -->
<script>
const ITEM_API_ENDPOINT = "{% url 'main:show_json' %}";
const ITEM_ADD_ENDPOINT = "{% url 'main:add_item_ajax' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const container = document.getElementById('item-container');
const loadingSpinner = document.getElementById('loading');
const errorMessage = document.getElementById('error');
const emptyStateDisplay = document.getElementById('empty');
const itemGridContainer = document.getElementById('grid');
const showAllItemButton = document.getElementById('filter-all');
const showMyItemButton = document.getElementById('filter-my');
const itemForm = document.getElementById("itemForm");
const refreshButton = document.getElementById('refresh-button'); 

let activeFilter = 'all';
let allItemData = [];
let itemToDelete = null;

console.log('App initialized. Current User ID:', CURRENT_USER_ID);

async function fetchAndDisplayItems(newFilter, isInitialLoad = false) {
  if (newFilter) {
      activeFilter = newFilter;
  }
  
  updateFilterButtonsAppearance();
  console.log(`Memproses item untuk filter: ${activeFilter}`);

  if (!isInitialLoad) {
    container.classList.add("opacity-0", "translate-y-6");
  } else {
    displayPageSection({ showLoading: true });
  }

  setTimeout(async () => {
    if (!isInitialLoad) displayPageSection({ showLoading: true });

    try {
      if (allItemData.length === 0) {
        console.log('Mengambil data baru dari server...');
        const response = await fetch(ITEM_API_ENDPOINT);
        if (!response.ok) throw new Error('Network response was not ok');
        const itemsData = await response.json();
        allItemData = itemsData || [];
        console.log('Data berhasil diambil:', allItemData.length, 'item.');
      } else {
        console.log('Menggunakan data dari cache.');
      }

      const filteredItems = activeFilter === 'all'
        ? allItemData
        : allItemData.filter(item => Number(item.user_id) === Number(CURRENT_USER_ID));

      console.log(`Ditemukan ${filteredItems.length} item untuk filter '${activeFilter}'`);

      if (filteredItems.length === 0) {
        displayPageSection({ showEmpty: true });
      } else {
        renderAllItemCards(filteredItems);
        displayPageSection({ showGrid: true });
      }

    } catch (error) {
      console.error('Error saat memuat item:', error);
      displayPageSection({ showError: true });
      errorMessage.innerHTML = `<div class="bg-red-100 text-red-700 p-4 rounded-lg text-center">Gagal memuat item.</div>`;
    } finally {
      container.classList.remove("opacity-0", "translate-y-6");
    }
  }, isInitialLoad ? 0 : 500);
}

function renderAllItemCards(items) {
  itemGridContainer.innerHTML = '';
  items.forEach(item => {
    const cardElement = buildItemCardElement(item);
    itemGridContainer.appendChild(cardElement);
  });

  {% if user.is_authenticated %}
  const createCard = document.createElement('div');
  createCard.onclick = () => { 
    if (typeof showModal === 'function') showModal();
    else console.warn('Fungsi showModal tidak ditemukan.');
  };
  createCard.className = "cursor-pointer bg-[#f1e6ff]/75 rounded-lg border-gray-200 flex items-center justify-center h-full min-h-[200px] hover:shadow-lg hover:scale-105 transition-transform duration-300 ease-in-out";
  createCard.innerHTML = `
    <div class="flex flex-col items-center justify-center text-center p-4">
      <span class="text-6xl text-[#4b4197] font-bold">+</span>
      <p class="mt-2 text-[#4b4197] font-custom1 font-semibold">Create New Item</p>
    </div>`;
  itemGridContainer.appendChild(createCard);
  {% endif %}
}

function updateFilterButtonsAppearance() {
    if (!showAllItemButton || !showMyItemButton) return;
    if (activeFilter === 'all') {
        showAllItemButton.className = 'bg-[#4b4197] text-white px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d]';
        showMyItemButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d] hover:text-white';
    } else {
        showMyItemButton.className = 'bg-[#4b4197] text-white px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d]';
        showAllItemButton.className = 'bg-white text-gray-700 border border-gray-300 px-4 py-2 rounded-md font-custom1 transition-all duration-300 hover:bg-[#3b347d] hover:text-white';
    }
}

function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
    loadingSpinner.classList.toggle('hidden', !showLoading);
    errorMessage.classList.toggle('hidden', !showError);
    emptyStateDisplay.classList.toggle('hidden', !showEmpty);
    itemGridContainer.classList.toggle('hidden', !showGrid);
    if (showGrid) {
        itemGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
    }
}

function buildItemCardElement(item) {
    const article = document.createElement('article');
    article.className = 'bg-[#f1e6ff]/75 rounded-lg border-gray-200 hover:shadow-lg transition-shadow duration-300 overflow-hidden flex flex-col h-full';
    const detailLink = `{% url 'main:show_items' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', item.id);
    const formattedDate = new Date(item.created_at).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    const categoryLabel = item.category_display || item.category || 'Uncategorized';
    const isFeatured = item.is_featured;
    const isHot = item.is_item_hot;
    const thumbnailHtml = item.thumbnail ? `<a href="${detailLink}" class="block w-full h-full"><img src='${item.thumbnail}' alt='${item.name}' class='w-full h-full object-cover'></a>` : item.thumbnail_custom ? `<a href="${detailLink}" class="block w-full h-full"><img src='${item.thumbnail_custom}' alt='${item.name}' class='w-full h-full object-cover'></a>` : `<a href="${detailLink}" class="block w-full h-full"><div class='w-full h-full bg-gray-200'></div></a>`;
    const featuredBadge = isFeatured ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800 font-custom1'>Featured</span>` : '';
    const hotBadge = isHot ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800 font-custom1'>Hot</span>` : '';
    
    const editDeleteButtons = CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(item.user_id) 
        ? `<div class='flex space-x-2'>
             <button onclick="showEditModal('${item.id}')" class='text-blue-600 hover:text-blue-700 text-sm transition-colors font-custom1'>Edit</button>
             <button onclick="showDeleteModal('${item.id}')" class='text-red-600 hover:text-red-700 text-sm transition-colors font-custom1'>Delete</button>
           </div>` 
        : '';
    
    article.innerHTML = `
    <div class="aspect-[16/9] relative overflow-hidden">
      ${thumbnailHtml}
      
      <div class="absolute top-3 left-3">
        <span class="inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium bg-purple-100 text-purple-800 font-custom1">
          ${categoryLabel}
        </span>
      </div>
      
      <div class="absolute top-3 right-3 flex space-x-2">
        ${featuredBadge}
        ${hotBadge}
      </div>
    </div>

    <div class="p-5 flex flex-col flex-1">
      
      <div class="flex items-center text-sm text-gray-500 mb-3 font-custom1">
        <time>${formattedDate}</time>
        <span class="mx-2">â€¢</span>
        <span>${item.item_views || 0} views</span>
      </div>
      
      <h3 class="text-lg font-semibold text-gray-900 mb-3 line-clamp-2 leading-tight font-custom1">
        <a href="${detailLink}" class="hover:text-[#4b4197] transition-colors">
          ${item.name}
        </a>
      </h3>
      
      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-3 font-custom1">
        ${item.description || ''}
      </p>
      
      <p class="text-green-600 font-bold text-lg font-custom1 mb-4">
        $${item.price || 0}
      </p>
      
      <div class="pt-4 border-t border-gray-100 flex items-center justify-between mt-auto">
        <a href="${detailLink}" class="text-[#4b4197] hover:text-[#3b347d] font-medium text-xl transition-colors font-custom1">
          Details
        </a>
        ${editDeleteButtons}
      </div>
      
    </div>
  `;
    return article;
}

function getCookie(name) { 
    let cookieValue = null; 
    if (document.cookie && document.cookie !== '') { 
        const cookies = document.cookie.split(';'); 
        for (let i = 0; i < cookies.length; i++) { 
            const cookie = cookies[i].trim(); 
            if (cookie.substring(0, name.length + 1) === (name + '=')) { 
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1)); 
                break; 
            } 
        } 
    } 
    return cookieValue; 
}

function showDeleteModal(itemId) { 
    itemToDelete = itemId; 
    document.getElementById("deleteModal").classList.remove("hidden"); 
}

function hideDeleteModal() { 
    itemToDelete = null; 
    document.getElementById("deleteModal").classList.add("hidden"); 
}

document.getElementById("cancelDelete").addEventListener("click", hideDeleteModal);

document.getElementById("confirmDelete").addEventListener("click", async () => {
  if (!itemToDelete) return;
  try {
    const deleteUrl = `{% url 'main:delete_item' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', itemToDelete);
    const response = await fetch(deleteUrl, { 
        method: "POST", 
        headers: { 'X-CSRFToken': getCookie('csrftoken') } 
    });
    if (response.ok) {
      if (typeof showToast === 'function') showToast("Item deleted successfully!", "", "success");
      hideDeleteModal();
      allItemData = [];
      fetchAndDisplayItems(activeFilter, true);
    } else { 
        if (typeof showToast === 'function') showToast("Failed to delete item.", "", "error"); 
    }
  } catch (error) { 
      if (typeof showToast === 'function') showToast("Error deleting item.", "", "error"); 
  }
});

if (itemForm) {
  itemForm.addEventListener("submit", async e => {
    e.preventDefault();
    await fetch(ITEM_ADD_ENDPOINT, { 
        method: "POST", 
        body: new FormData(itemForm) 
    });
    itemForm.reset();
    if (typeof hideModal === 'function') hideModal();
    if (typeof showToast === 'function') showToast('Item added successfully!', '', 'success');
    allItemData = [];
    fetchAndDisplayItems(activeFilter, true);
  });
}

document.addEventListener('itemAdded', () => {
    allItemData = [];
    fetchAndDisplayItems(activeFilter, true);
});

function initializePage() {
  if (showAllItemButton) {
    showAllItemButton.addEventListener('click', () => fetchAndDisplayItems('all'));
  }
  if (showMyItemButton) {
    showMyItemButton.addEventListener('click', () => fetchAndDisplayItems('my'));
  }
  
  if (refreshButton) {
    refreshButton.addEventListener('click', () => {
      console.log('Tombol refresh diklik! Mengambil data terbaru.');
      allItemData = [];
      fetchAndDisplayItems(activeFilter, false); 
    });
  }
  
  // mengambil data
  fetchAndDisplayItems('all', true);
}

window.showDeleteModal = showDeleteModal;
window.getCookie = getCookie;

initializePage();
</script>

{% endblock content %}